<% if (theme.plugins.parallax.enable) { %>
    <% var imgs = theme.plugins.parallax.images || page.images; %>
  <script>
    var imgs=<%- '["' + imgs.join('", "') + '"]' %>;
    var index=0;
    <% if (theme.plugins.parallax.shuffle) { %>
        function shuffle(arr){
          /*From countercurrent-time*/
          var n = arr.length;
          while(n--) {
            var index = Math.floor(Math.random() * n);
            var temp = arr[index];
            arr[index] = arr[n];
            arr[n] = temp;
          }
        }
        shuffle(imgs);
    <% } %>
    // https://github.com/pixelcog/parallax.js/tree/v2.0.0-alpha
    // 这是 2.0.0-alpha，（1.x不兼容pjax） alpha版本官方尚未正式发布 上一次更新时间：30 Nov 2017
    loadScript('<%- theme.plugins.parallax.js %>')
    function parallax(src){
      $('#parallax-window').parallax({
        src: src,
        speed: .25,
        bleed: 0,
        zIndex: -100,
        posX: 'center',
        posY: 'center',
        overScrollFix: false,
        excludeAgents: /(iPod|iPhone|iPad|Android)/,
        aspectRatio: null,
        // jquery selectors
        sliderSelector: '>.parallax-slider',
        mirrorSelector: '#l_cover',
        // callback functions:
        afterRefresh: ()=>{
          // console.log("afterRefresh")
        },
        afterRender: ()=>{
          // console.log("afterRender")
        },
        afterSetup: ()=>{
          // console.log("afterSetup")
          setInterval(()=>{
            var le=imgs.length;
            //背景图透明度变为0
            $('.parallax-mirror img').fadeOut(300,function(){
              $('.parallax-mirror img')[0].setAttribute("src",imgs[index]);
              //立刻将透明度变为1
              setTimeout(()=>{
                $('.parallax-mirror img').fadeIn(500);
              },300)
            });
            // if($('#l_cover').css("opacity")==="0"){
              //切换图片
            // }
            index++;
            if(index==le)index=0;
          },10000)
        },
        afterDestroy: ()=>{
          // console.log("afterDestroy")
        },
      });
    }

    // function changebg(){
    //   var le=imgs.length;
    //   //背景图透明度变为0
    //   $('.parallax-mirror img').fadeOut(300,function(){
    //     $('.parallax-mirror img')[0].setAttribute("src",imgs[index]);
    //     //立刻将透明度变为1
    //     $('.parallax-mirror img').fadeIn(500);
    //   });
    //   // if($('#l_cover').css("opacity")==="0"){
    //     //切换图片
    //   // }
    //   index++;
    //   if(index==le)index=0;
    //   var clock=setTimeout(function(){
    //     changebg();
    //   },3000);
    // }

    function next_parallax(){
      $("#l_cover .parallax-mirror img")[0].src=imgs[(index)%(imgs.length)];
      index++;
      fetch(imgs[(index)%(imgs.length)]); // cach
    }
    function pjax_parallax(){
      next_parallax();
      volantis.IntervalParallax = setInterval(function () {
        next_parallax();
      }, 15000)
    }
    var checkParallax = setInterval(function () {
        if ($("#safearea").css("display")!="block") return 
        if (typeof $('#parallax-window').parallax == 'undefined') return 
      clearInterval(checkParallax)
      parallax(imgs[(index)%(imgs.length)]);
    }, 500)
    volantis.pjax.push(pjax_parallax);
    volantis.pjax.send(()=>{
        try {
          clearInterval(volantis.IntervalParallax);
        } catch (error) {}
      },'pjax_parallax')
  </script>
  <% } %>